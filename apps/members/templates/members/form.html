{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<style>
    .form-section {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: none;
    }
    
    .section-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #495057;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: 0;
    }
    
    .section-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .section-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }
    
    .section-body {
        padding: 25px;
    }
    
    .form-floating {
        margin-bottom: 1.2rem;
    }
    
    .form-floating label {
        color: #6c757d;
        font-weight: 500;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
    
    .form-help {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .form-help h6 {
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .current-value {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #28a745;
    }
    
    .current-value-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .current-value-text {
        font-size: 1.1rem;
        color: #212529;
        margin-top: 5px;
    }
    
    .btn-save-group {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-top: 20px;
        border: 1px solid #dee2e6;
    }
    
    /* Profile Image Styling */
    .profile-image-container {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto 20px;
    }

    .profile-image-container .profile-avatar {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        border: 4px solid #fff;
    }

    .avatar-placeholder {
        width: 150px;
        height: 150px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid #fff;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .avatar-title {
        font-size: 56px;
        color: white;
        font-weight: 600;
    }

    .profile-image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 150px;
        height: 150px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }

    .profile-image-container:hover .profile-image-overlay {
        opacity: 1;
    }

    .profile-image-overlay i {
        color: white;
        font-size: 28px;
    }

    /* Image Cropper Modal Styling */
    #image-container {
        max-width: 100%;
        margin: 0 auto;
    }

    #imagePreview {
        max-width: 100%;
        max-height: 400px;
        display: block;
        margin: 0 auto;
    }

    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .image-upload-area:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
    }

    .image-upload-area.dragover {
        border-color: #667eea;
        background-color: #f0f2ff;
    }

    .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 1rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-ACTIVE {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-PENDING_APPROVAL {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .status-SUSPENDED {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-DORMANT {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    .disabled-field {
        opacity: 0.6;
        pointer-events: none;
    }

    .readonly-field {
        background-color: #f8f9fa !important;
        cursor: not-allowed;
    }
    
    .error-summary {
        background-color: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .error-summary h6 {
        color: #c53030;
        margin-bottom: 10px;
    }

    .error-list {
        margin: 0;
        padding-left: 20px;
    }

    .error-list li {
        color: #742a2a;
        margin-bottom: 5px;
    }

    .field-group {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #fdfdfe;
    }
    
    .field-group-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
    }

    .member-info-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        margin: 0.25rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 500;
        background-color: #e7f3ff;
        color: #0066cc;
    }

    .kyc-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .kyc-verified {
        background-color: #d4edda;
        color: #155724;
    }

    .kyc-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .kyc-rejected {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    @media (max-width: 768px) {
        .section-body {
            padding: 15px;
        }
        
        .btn-save-group {
            padding: 15px;
        }

        .profile-image-container,
        .profile-image-container .profile-avatar,
        .avatar-placeholder,
        .profile-image-overlay {
            width: 120px;
            height: 120px;
        }

        .avatar-title {
            font-size: 48px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-user icon-gradient bg-mean-fruit"></i>
            </div>
            <div>
                {% if form.instance.pk %}Update Member{% else %}Add New Member{% endif %}
                <div class="page-title-subheading">
                    {% if form.instance.pk %}
                        Update information for {{ form.instance.get_full_name }} ({{ form.instance.member_number }})
                    {% else %}
                        Add a new member to the SACCO
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="page-title-actions">
            <div class="dropdown">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fa fa-ellipsis-v me-1"></i> Actions
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    {% if form.instance.pk %}
                        <a class="dropdown-item" href="{% url 'members:member_profile' form.instance.pk %}">
                            <i class="fa fa-eye me-2"></i> View Profile
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="fa fa-users me-2"></i> Manage Next of Kin
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="fa fa-credit-card me-2"></i> Payment Methods
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="fa fa-file-alt me-2"></i> Documents
                        </a>
                        <div class="dropdown-divider"></div>
                    {% endif %}
                    <a class="dropdown-item" href="{% url 'members:member_list' %}">
                        <i class="fa fa-list me-2"></i> Back to Member List
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Form Help Section -->
<div class="form-help">
    <h6><i class="fa fa-info-circle me-1"></i> {% if form.instance.pk %}Update{% else %}Registration{% endif %} Guidelines</h6>
    <div class="row">
        <div class="col-md-6">
            <ul class="mb-0">
                <li><strong>Required fields</strong> are marked with an asterisk (*)</li>
                {% if form.instance.pk %}
                    <li><strong>Member number</strong> cannot be changed after creation</li>
                    <li><strong>Status changes</strong> will be tracked with reasons</li>
                {% else %}
                    <li><strong>Member number</strong> will be auto-generated if not provided</li>
                    <li><strong>KYC verification</strong> is required for active status</li>
                {% endif %}
            </ul>
        </div>
        <div class="col-md-6">
            <ul class="mb-0">
                <li><strong>Profile photos</strong> should be clear headshots (max 5MB)</li>
                {% if form.instance.pk %}
                    <li><strong>Credit score</strong> is auto-calculated based on member data</li>
                    <li>Use "Save Changes" to apply all modifications</li>
                {% else %}
                    <li><strong>Payment methods</strong> can be added after member creation</li>
                    <li>Use "Save Member" to create the new record</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced Error Display Section -->
{% if form.errors or form.non_field_errors %}
<div class="error-summary">
    <h6><i class="fa fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
    
    {% if form.non_field_errors %}
        <div class="mb-3">
            <strong>Form Errors:</strong>
            <ul class="error-list">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    {% if form.errors %}
        <div class="mb-3">
            <strong>Field Errors:</strong>
            <ul class="error-list">
                {% for field, errors in form.errors.items %}
                    {% if field != '__all__' %}
                        <li><strong>{{ field|title }}:</strong>
                            {% for error in errors %}
                                {{ error }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Current Status Display (for updates only) -->
{% if form.instance.pk %}
<div class="current-value">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="current-value-label">Current Member Status</div>
            <div class="current-value-text">
                <span class="status-badge status-{{ form.instance.status }}">
                    {{ form.instance.get_status_display }}
                </span>
                <span class="member-info-badge">
                    <i class="fa fa-tag me-1"></i>{{ form.instance.get_member_category_display }}
                </span>
                <span class="member-info-badge">
                    <i class="fa fa-certificate me-1"></i>{{ form.instance.get_membership_plan_display }}
                </span>
                {% if form.instance.is_kyc_verified %}
                    <span class="kyc-indicator kyc-verified">
                        <i class="fa fa-check-circle"></i> KYC Verified
                    </span>
                {% else %}
                    <span class="kyc-indicator kyc-{{ form.instance.kyc_status|lower }}">
                        <i class="fa fa-clock"></i> KYC {{ form.instance.get_kyc_status_display }}
                    </span>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4 text-end">
            <small class="text-muted">
                Member Since: {{ form.instance.membership_date|date:"M d, Y" }}<br>
                Duration: {{ form.instance.membership_duration_years|floatformat:1 }} years<br>
                {% if form.instance.age %}Age: {{ form.instance.age }} years{% endif %}
            </small>
        </div>
    </div>
</div>
{% endif %}

<!-- Main Form -->
<form method="post" enctype="multipart/form-data" id="member-form" novalidate>
    {% csrf_token %}
    
    <!-- Basic Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-user me-2"></i>Basic Information</h6>
            <p>Personal details and identification information</p>
        </div>
        <div class="section-body">
            <!-- Profile Photo -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-camera me-2"></i>Profile Photo
                </div>
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="profile-image-container mb-3">
                            {% if form.instance.member_photo %}
                                <img id="currentProfileImage" src="{{ form.instance.member_photo.url }}" alt="{{ form.instance.get_full_name }}" class="profile-avatar">
                            {% else %}
                                <div class="avatar-placeholder">
                                    <div class="avatar-title">
                                        {% if form.instance.first_name %}{{ form.instance.first_name|first }}{% endif %}{% if form.instance.last_name %}{{ form.instance.last_name|first }}{% endif %}
                                    </div>
                                </div>
                            {% endif %}
                            <div class="profile-image-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="small text-muted">Click to change photo</div>
                    </div>
                    <div class="col-md-9">
                        <div class="mt-2">
                            <strong>Profile Photo</strong>
                            <div class="small text-muted mt-1">
                                Click on the image to update the member's photo.<br>
                                Supported formats: JPG, PNG, GIF (Max: 5MB)<br>
                                Recommended: Square image, minimum 300x300 pixels
                            </div>
                        </div>
                        <!-- Hidden file input for form submission -->
                        {{ form.member_photo|add_class:"d-none" }}
                        {% if form.member_photo.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.member_photo.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Member Number and ID -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {% if form.instance.pk %}
                            {{ form.member_number|add_class:"form-control readonly-field" }}
                        {% else %}
                            {{ form.member_number|add_class:"form-control" }}
                        {% endif %}
                        <label for="{{ form.member_number.id_for_label }}" class="{% if form.member_number.field.required %}required-field{% endif %}">Member Number</label>
                        {% if form.member_number.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.member_number.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.instance.pk %}
                            <div class="form-text">Member number cannot be changed</div>
                        {% else %}
                            <div class="form-text">Leave blank to auto-generate</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.id_number|add_class:"form-control" }}
                        <label for="{{ form.id_number.id_for_label }}" class="{% if form.id_number.field.required %}required-field{% endif %}">ID Number</label>
                        {% if form.id_number.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.id_number.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Name Fields -->
            <div class="row">
                <div class="col-md-2">
                    <div class="form-floating">
                        {{ form.title|add_class:"form-select" }}
                        <label for="{{ form.title.id_for_label }}">Title</label>
                        {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.title.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.first_name|add_class:"form-control" }}
                        <label for="{{ form.first_name.id_for_label }}" class="{% if form.first_name.field.required %}required-field{% endif %}">First Name</label>
                        {% if form.first_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.first_name.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        {{ form.middle_name|add_class:"form-control" }}
                        <label for="{{ form.middle_name.id_for_label }}">Middle Name</label>
                        {% if form.middle_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.middle_name.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        {{ form.last_name|add_class:"form-control" }}
                        <label for="{{ form.last_name.id_for_label }}" class="{% if form.last_name.field.required %}required-field{% endif %}">Last Name</label>
                        {% if form.last_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.last_name.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Personal Details -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.date_of_birth|add_class:"form-control" }}
                        <label for="{{ form.date_of_birth.id_for_label }}" class="{% if form.date_of_birth.field.required %}required-field{% endif %}">Date of Birth</label>
                        {% if form.date_of_birth.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.date_of_birth.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div id="age-display" class="form-text"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.gender|add_class:"form-select" }}
                        <label for="{{ form.gender.id_for_label }}" class="{% if form.gender.field.required %}required-field{% endif %}">Gender</label>
                        {% if form.gender.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.gender.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.marital_status|add_class:"form-select" }}
                        <label for="{{ form.marital_status.id_for_label }}" class="{% if form.marital_status.field.required %}required-field{% endif %}">Marital Status</label>
                        {% if form.marital_status.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.marital_status.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.place_of_birth|add_class:"form-control" }}
                        <label for="{{ form.place_of_birth.id_for_label }}">Place of Birth</label>
                        {% if form.place_of_birth.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.place_of_birth.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.nationality|add_class:"form-select" }}
                        <label for="{{ form.nationality.id_for_label }}">Nationality</label>
                        {% if form.nationality.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.nationality.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.religious_affiliation|add_class:"form-select" }}
                        <label for="{{ form.religious_affiliation.id_for_label }}">Religious Affiliation</label>
                        {% if form.religious_affiliation.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.religious_affiliation.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ID Type -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.id_type|add_class:"form-select" }}
                        <label for="{{ form.id_type.id_for_label }}">ID Type</label>
                        {% if form.id_type.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.id_type.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Membership Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-id-card me-2"></i>Membership Information</h6>
            <p>Membership category, plan, and status details</p>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.member_category|add_class:"form-select" }}
                        <label for="{{ form.member_category.id_for_label }}">Member Category</label>
                        {% if form.member_category.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.member_category.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.membership_plan|add_class:"form-select" }}
                        <label for="{{ form.membership_plan.id_for_label }}">Membership Plan</label>
                        {% if form.membership_plan.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.membership_plan.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.membership_application_date|add_class:"form-control" }}
                        <label for="{{ form.membership_application_date.id_for_label }}">Application Date</label>
                        {% if form.membership_application_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.membership_application_date.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.membership_date|add_class:"form-control" }}
                        <label for="{{ form.membership_date.id_for_label }}" class="{% if form.membership_date.field.required %}required-field{% endif %}">Membership Date</label>
                        {% if form.membership_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.membership_date.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.membership_approved_date|add_class:"form-control" }}
                        <label for="{{ form.membership_approved_date.id_for_label }}">Approval Date</label>
                        {% if form.membership_approved_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.membership_approved_date.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.status|add_class:"form-select" }}
                        <label for="{{ form.status.id_for_label }}" class="{% if form.status.field.required %}required-field{% endif %}">Status</label>
                        {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.status.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.status_changed_reason|add_class:"form-control" }}
                        <label for="{{ form.status_changed_reason.id_for_label }}">Status Change Reason</label>
                        {% if form.status_changed_reason.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.status_changed_reason.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Membership Benefits -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-gift me-2"></i>Membership Benefits
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.maximum_loan_multiplier|add_class:"form-control" }}
                            <label for="{{ form.maximum_loan_multiplier.id_for_label }}">Maximum Loan Multiplier</label>
                            {% if form.maximum_loan_multiplier.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.maximum_loan_multiplier.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Times savings balance (e.g., 3.0 = 3x savings)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.loan_interest_discount|add_class:"form-control" }}
                            <label for="{{ form.loan_interest_discount.id_for_label }}">Loan Interest Discount (%)</label>
                            {% if form.loan_interest_discount.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.loan_interest_discount.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Discount percentage off standard interest rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-envelope me-2"></i>Contact Information</h6>
            <p>Email, phone, and physical address details</p>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.personal_email|add_class:"form-control" }}
                        <label for="{{ form.personal_email.id_for_label }}">Personal Email</label>
                        {% if form.personal_email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.personal_email.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.phone_primary|add_class:"form-control" }}
                        <label for="{{ form.phone_primary.id_for_label }}" class="{% if form.phone_primary.field.required %}required-field{% endif %}">Primary Phone Number</label>
                        {% if form.phone_primary.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.phone_primary.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-floating">
                {{ form.physical_address|add_class:"form-control" }}
                <label for="{{ form.physical_address.id_for_label }}" class="{% if form.physical_address.field.required %}required-field{% endif %}">Physical Address</label>
                {% if form.physical_address.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.physical_address.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.postal_address|add_class:"form-control" }}
                        <label for="{{ form.postal_address.id_for_label }}">Postal Address</label>
                        {% if form.postal_address.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.postal_address.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.postal_code|add_class:"form-control" }}
                        <label for="{{ form.postal_code.id_for_label }}">Postal Code</label>
                        {% if form.postal_code.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.postal_code.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.city|add_class:"form-control" }}
                        <label for="{{ form.city.id_for_label }}">City</label>
                        {% if form.city.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.city.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.state_province|add_class:"form-control" }}
                        <label for="{{ form.state_province.id_for_label }}">State/Province</label>
                        {% if form.state_province.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.state_province.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        {{ form.country|add_class:"form-select" }}
                        <label for="{{ form.country.id_for_label }}">Country</label>
                        {% if form.country.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.country.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Employment & Financial Information Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-briefcase me-2"></i>Employment & Financial Information</h6>
            <p>Employment status, income, and occupation details</p>
        </div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.employment_status|add_class:"form-select" }}
                        <label for="{{ form.employment_status.id_for_label }}" class="{% if form.employment_status.field.required %}required-field{% endif %}">Employment Status</label>
                        {% if form.employment_status.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.employment_status.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.occupation|add_class:"form-control" }}
                        <label for="{{ form.occupation.id_for_label }}">Occupation</label>
                        {% if form.occupation.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.occupation.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.employer|add_class:"form-control" }}
                        <label for="{{ form.employer.id_for_label }}">Employer</label>
                        {% if form.employer.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.employer.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.monthly_income|add_class:"form-control" }}
                        <label for="{{ form.monthly_income.id_for_label }}">Monthly Income</label>
                        {% if form.monthly_income.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.monthly_income.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-floating">
                {{ form.employer_address|add_class:"form-control" }}
                <label for="{{ form.employer_address.id_for_label }}">Employer Address</label>
                {% if form.employer_address.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.employer_address.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-floating">
                {{ form.income_source|add_class:"form-control" }}
                <label for="{{ form.income_source.id_for_label }}">Primary Income Source</label>
                {% if form.income_source.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.income_source.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-floating">
                {{ form.other_income_sources|add_class:"form-control" }}
                <label for="{{ form.other_income_sources.id_for_label }}">Other Income Sources</label>
                {% if form.other_income_sources.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.other_income_sources.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tax & Compliance Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-file-invoice me-2"></i>Tax & Compliance</h6>
            <p>Tax information and KYC verification status</p>
        </div>
        <div class="section-body">
            <!-- Tax Information -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-receipt me-2"></i>Tax Information
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.tax_id|add_class:"form-control" }}
                            <label for="{{ form.tax_id.id_for_label }}">Tax ID (TIN)</label>
                            {% if form.tax_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tax_id.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch mt-4">
                            {{ form.tax_exemption_status|add_class:"form-check-input" }}
                            <label class="form-check-label" for="{{ form.tax_exemption_status.id_for_label }}">
                                <strong>Tax Exempt</strong>
                            </label>
                            {% if form.tax_exemption_status.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.tax_exemption_status.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-floating" id="tax-exemption-reason-container">
                    {{ form.tax_exemption_reason|add_class:"form-control" }}
                    <label for="{{ form.tax_exemption_reason.id_for_label }}">Tax Exemption Reason</label>
                    {% if form.tax_exemption_reason.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.tax_exemption_reason.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- KYC Information -->
            <div class="field-group">
                <div class="field-group-header">
                    <i class="fa fa-shield-alt me-2"></i>KYC (Know Your Customer)
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ form.kyc_status|add_class:"form-select" }}
                            <label for="{{ form.kyc_status.id_for_label }}">KYC Status</label>
                            {% if form.kyc_status.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.kyc_status.errors %}
                                        {{ error }}{% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-floating">
                    {{ form.kyc_notes|add_class:"form-control" }}
                    <label for="{{ form.kyc_notes.id_for_label }}">KYC Notes</label>
                    {% if form.kyc_notes.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.kyc_notes.errors %}
                                {{ error }}{% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Risk & Credit Section -->
    <div class="form-section">
        <div class="section-header">
            <h6><i class="fa fa-chart-line me-2"></i>Risk & Credit Assessment</h6>
            <p>Credit score and risk rating information</p>
        </div>
        <div class="section-body">
            <div class="alert alert-info">
                <i class="fa fa-info-circle me-2"></i>
                <strong>Note:</strong> Credit score is automatically calculated based on member data. 
                You can manually override it if needed.
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.credit_score|add_class:"form-control" }}
                        <label for="{{ form.credit_score.id_for_label }}">Credit Score (0-1000)</label>
                        {% if form.credit_score.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.credit_score.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Auto-calculated on save. Higher is better.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        {{ form.risk_rating|add_class:"form-select" }}
                        <label for="{{ form.risk_rating.id_for_label }}">Risk Rating</label>
                        {% if form.risk_rating.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.risk_rating.errors %}
                                    {{ error }}{% if not forloop.last %}<br>{% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Auto-updated based on credit score</div>
                    </div>
                </div>
            </div>
            
            <div class="form-floating">
                {{ form.risk_assessment_notes|add_class:"form-control" }}
                <label for="{{ form.risk_assessment_notes.id_for_label }}">Risk Assessment Notes</label>
                {% if form.risk_assessment_notes.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.risk_assessment_notes.errors %}
                            {{ error }}{% if not forloop.last %}<br>{% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Save Button Group -->
    <div class="btn-save-group">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'members:member_list' %}" class="btn btn-outline-secondary">
                    <i class="fa fa-times me-1"></i> Cancel
                </a>
                {% if form.instance.pk %}
                    <a href="{% url 'members:member_profile' form.instance.pk %}" class="btn btn-outline-info ms-2">
                        <i class="fa fa-eye me-1"></i> View Profile
                    </a>
                {% endif %}
            </div>
            <div>
                <button type="button" class="btn btn-outline-warning me-2" onclick="resetForm()">
                    <i class="fa fa-undo me-1"></i> Reset Changes
                </button>
                <button type="submit" class="btn btn-primary" id="save-btn">
                    <span class="spinner-border spinner-border-sm me-1" style="display: none;" id="save-spinner"></span>
                    <i class="fa fa-save me-1" id="save-icon"></i>
                    {% if form.instance.pk %}Save Changes{% else %}Save Member{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Profile Image Modal -->
<div class="modal fade" id="profileImageModal" tabindex="-1" role="dialog" aria-labelledby="profileImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileImageModalLabel">
                    <i class="fa fa-camera me-2"></i>Update Member Photo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Browse Section -->
                <div id="browse-section" class="text-center">
                    <div class="image-upload-area" onclick="document.getElementById('uploadImage').click()">
                        <i class="fa fa-cloud-upload upload-icon"></i>
                        <h6>Choose an image to upload</h6>
                        <p class="text-muted mb-0">Click here or drag and drop your image</p>
                        <small class="text-muted">Supports JPG, PNG, GIF (Max: 5MB)</small>
                    </div>
                    <input type="file" id="uploadImage" accept="image/*" class="d-none">
                </div>
                
                <!-- Image Preview Section -->
                <div id="image-container" class="text-center mt-3" style="display: none;">
                    <img id="imagePreview" src="" alt="Image Preview" class="img-fluid">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancel
                </button>
                <button type="button" id="btnCrop" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-crop me-1"></i>Crop Image
                </button>
                <button type="button" id="btnSave" class="btn btn-success" style="display: none;">
                    <i class="fas fa-save me-1"></i>Use This Photo
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeFormValidation();
    setupImageHandling();
    trackFormChanges();
    setupFieldEnhancements();
    setupConditionalFields();
    addNavigationWarning();
});

// Initialize form validation
function initializeFormValidation() {
    const form = document.getElementById('member-form');
    
    form.addEventListener('submit', function(e) {
        const saveBtn = document.getElementById('save-btn');
        const saveSpinner = document.getElementById('save-spinner');
        const saveIcon = document.getElementById('save-icon');
        
        // Check for validation errors
        const invalidFields = form.querySelectorAll(':invalid');
        if (invalidFields.length > 0) {
            e.preventDefault();
            showFormValidationErrors();
            return false;
        }
        
        // Show loading state
        if (saveBtn) {
            saveBtn.disabled = true;
            if (saveSpinner) saveSpinner.style.display = 'inline-block';
            if (saveIcon) saveIcon.style.display = 'none';
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
        }
        
        return true;
    });
    
    // Real-time validation
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateField(this);
        });
        
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateField(this);
            }
        });
    });
    
    // Email validation
    const emailFields = form.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateEmailField(this);
        });
    });
    
    // Phone number formatting
    const phoneFields = form.querySelectorAll('input[name*="phone"]');
    phoneFields.forEach(field => {
        field.addEventListener('input', function() {
            formatPhoneNumber(this);
        });
    });
}

// Show form validation errors
function showFormValidationErrors() {
    const form = document.getElementById('member-form');
    const invalidFields = form.querySelectorAll(':invalid');
    
    if (invalidFields.length > 0) {
        invalidFields[0].focus();
        invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        invalidFields.forEach(field => {
            field.classList.add('is-invalid');
        });
    }
}

// Setup conditional fields
function setupConditionalFields() {
    // Tax exemption reason visibility
    const taxExemptCheck = document.querySelector('input[name="tax_exemption_status"]');
    const taxExemptReasonContainer = document.getElementById('tax-exemption-reason-container');
    const taxExemptReasonField = document.querySelector('textarea[name="tax_exemption_reason"]');
    
    if (taxExemptCheck && taxExemptReasonContainer) {
        function toggleTaxExemptReason() {
            if (taxExemptCheck.checked) {
                taxExemptReasonContainer.style.display = 'block';
                taxExemptReasonField.disabled = false;
            } else {
                taxExemptReasonContainer.style.display = 'none';
                taxExemptReasonField.disabled = true;
                taxExemptReasonField.value = '';
            }
        }
        
        taxExemptCheck.addEventListener('change', toggleTaxExemptReason);
        toggleTaxExemptReason(); // Initial state
    }
    
    // Auto-fill membership date with application date if empty
    const applicationDate = document.querySelector('input[name="membership_application_date"]');
    const membershipDate = document.querySelector('input[name="membership_date"]');
    
    if (applicationDate && membershipDate) {
        applicationDate.addEventListener('change', function() {
            if (!membershipDate.value && this.value) {
                membershipDate.value = this.value;
            }
        });
    }
}

// Setup image handling with cropper
function setupImageHandling() {
    const uploadImageInput = document.getElementById("uploadImage");
    const imagePreview = document.getElementById("imagePreview");
    const btnCrop = document.getElementById("btnCrop");
    const btnSave = document.getElementById("btnSave");
    const browseSection = document.getElementById("browse-section");
    const imageContainer = document.getElementById("image-container");
    const profileImageModal = document.getElementById('profileImageModal');
    
    if (!profileImageModal) return;
    
    const modalInstance = new bootstrap.Modal(profileImageModal);
    let cropper = null;
    let croppedImageData = null;

    function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const form = document.getElementById('member-form');
        form.insertAdjacentElement('afterbegin', alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    function resetCropper() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        if (imagePreview) imagePreview.src = '';
        if (browseSection) browseSection.style.display = "block";
        if (imageContainer) imageContainer.style.display = "none";
        if (btnCrop) btnCrop.style.display = "none";
        if (btnSave) btnSave.style.display = "none";
        
        if (uploadImageInput) {
            uploadImageInput.value = '';
        }
    }

    const profileImageOverlay = document.querySelector('.profile-image-overlay');
    if (profileImageOverlay) {
        profileImageOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            modalInstance.show();
        });
    }
    
    profileImageModal.addEventListener('hidden.bs.modal', function() {
        resetCropper();
    });

    if (uploadImageInput) {
        uploadImageInput.addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showAlert('danger', 'File size must be less than 5MB.');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('danger', 'Please select a valid image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (browseSection) browseSection.style.display = "none";
                if (imageContainer) imageContainer.style.display = "block";
                if (imagePreview) imagePreview.src = e.target.result;
                
                if (cropper) {
                    cropper.destroy();
                }
                
                if (imagePreview) {
                    setTimeout(() => {
                        try {
                            cropper = new Cropper(imagePreview, {
                                aspectRatio: 1,
                                viewMode: 2,
                                dragMode: "move",
                                background: true,
                                responsive: true,
                                autoCropArea: 0.8,
                                ready: function() {
                                    if (btnCrop) btnCrop.style.display = "inline-block";
                                }
                            });
                        } catch (err) {
                            console.error("Cropper initialization error:", err);
                            showAlert('danger', 'Error initializing image cropper. Please try again.');
                        }
                    }, 200);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    if (btnCrop) {
        btnCrop.addEventListener("click", function() {
            if (!cropper) return;
            
            try {
                const canvas = cropper.getCroppedCanvas({
                    width: 400,
                    height: 400,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });
                
                croppedImageData = canvas.toDataURL("image/jpeg", 0.9);
                if (imagePreview) imagePreview.src = croppedImageData;
                
                cropper.destroy();
                cropper = null;
                
                if (btnCrop) btnCrop.style.display = "none";
                if (btnSave) btnSave.style.display = "inline-block";
            } catch (err) {
                console.error("Cropping error:", err);
                showAlert('danger', 'Error cropping image. Please try again.');
            }
        });
    }

    if (btnSave) {
        btnSave.addEventListener("click", function() {
            if (!croppedImageData) return;

            btnSave.disabled = true;
            btnSave.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Saving...';

            try {
                const blobBin = atob(croppedImageData.split(',')[1]);
                const array = [];
                for(let i = 0; i < blobBin.length; i++) {
                    array.push(blobBin.charCodeAt(i));
                }
                const file = new Blob([new Uint8Array(array)], {type: 'image/jpeg'});

                const dt = new DataTransfer();
                dt.items.add(new File([file], 'member_photo.jpg', {type: 'image/jpeg'}));
                
                const hiddenFileInput = document.querySelector('input[name="member_photo"]');
                if (hiddenFileInput) {
                    hiddenFileInput.files = dt.files;
                }

                const currentProfileImage = document.getElementById("currentProfileImage");
                if (currentProfileImage) {
                    currentProfileImage.src = croppedImageData;
                } else {
                    const placeholder = document.querySelector('.avatar-placeholder');
                    if (placeholder) {
                        const container = placeholder.parentElement;
                        container.innerHTML = `
                            <img id="currentProfileImage" src="${croppedImageData}" alt="Profile Picture" class="profile-avatar">
                            <div class="profile-image-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        `;
                        
                        const newOverlay = container.querySelector('.profile-image-overlay');
                        if (newOverlay) {
                            newOverlay.addEventListener('click', function(e) {
                                e.preventDefault();
                                modalInstance.show();
                            });
                        }
                    }
                }
                
                showAlert('success', 'Member photo updated! Remember to save the form to apply changes.');
                modalInstance.hide();
            } catch (err) {
                console.error("Error preparing image:", err);
                showAlert('danger', 'Error preparing image. Please try again.');
            } finally {
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fas fa-save me-1"></i>Use This Photo';
            }
        });
    }
    
    const uploadArea = document.querySelector('.image-upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadImageInput.files = files;
                uploadImageInput.dispatchEvent(new Event('change'));
            }
        });
    }
}

let hasUnsavedChanges = false;

function trackFormChanges() {
    const form = document.getElementById('member-form');
    const formFields = form.querySelectorAll('input, select, textarea');
    
    formFields.forEach(field => {
        field.addEventListener('change', function() {
            hasUnsavedChanges = true;
            if (this.type === 'checkbox') {
                this.parentElement.classList.add('border-warning');
            } else {
                this.classList.add('border-warning');
            }
        });
    });
    
    form.addEventListener('submit', function() {
        hasUnsavedChanges = false;
    });
}

function addNavigationWarning() {
    const navigationLinks = document.querySelectorAll('a[href*="member"]');
    navigationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to leave?')) {
                    e.preventDefault();
                }
            }
        });
    });
}

function setupFieldEnhancements() {
    // Capitalize names automatically
    const nameFields = document.querySelectorAll('input[name*="name"]:not([name*="user"])');
    nameFields.forEach(field => {
        field.addEventListener('input', function() {
            capitalizeField(this);
        });
    });
    
    // Format ID numbers
    const idFields = document.querySelectorAll('input[name*="id_number"], input[name="tax_id"]');
    idFields.forEach(field => {
        field.addEventListener('input', function() {
            this.value = this.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
        });
    });
    
    // Date validation
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        field.addEventListener('change', function() {
            validateDateField(this);
        });
    });
    
    // Age calculation display
    const dobField = document.querySelector('input[name="date_of_birth"]');
    if (dobField) {
        dobField.addEventListener('change', function() {
            updateAgeDisplay(this.value);
        });
        
        if (dobField.value) {
            updateAgeDisplay(dobField.value);
        }
    }
}

function updateAgeDisplay(dateOfBirth) {
    if (!dateOfBirth) return;
    
    const today = new Date();
    const dob = new Date(dateOfBirth);
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    
    let ageDisplay = document.getElementById('age-display');
    if (!ageDisplay) {
        ageDisplay = document.createElement('div');
        ageDisplay.id = 'age-display';
        ageDisplay.className = 'form-text';
        
        const dobContainer = document.querySelector('input[name="date_of_birth"]').closest('.form-floating');
        dobContainer.appendChild(ageDisplay);
    }
    
    ageDisplay.textContent = `Age: ${age} years`;
    
    if (age < 16 || age > 100) {
        ageDisplay.className = 'form-text text-danger';
        ageDisplay.textContent += ' (Age seems unusual for a member)';
    } else {
        ageDisplay.className = 'form-text text-muted';
    }
}

function validateField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    if (field.hasAttribute('required') && !field.value.trim()) {
        field.classList.add('is-invalid');
        return false;
    }
    
    if (field.type === 'email' && field.value && !isValidEmail(field.value)) {
        field.classList.add('is-invalid');
        return false;
    }
    
    if (field.value.trim()) {
        field.classList.add('is-valid');
    }
    
    return true;
}

function validateEmailField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    if (field.value && !isValidEmail(field.value)) {
        field.classList.add('is-invalid');
        return false;
    }
    
    if (field.value) {
        field.classList.add('is-valid');
    }
    
    return true;
}

function validateDateField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    if (field.value) {
        const date = new Date(field.value);
        const today = new Date();
        
        if (field.name === 'date_of_birth') {
            if (date > today) {
                field.classList.add('is-invalid');
                return false;
            }
            const age = (today - date) / (365.25 * 24 * 60 * 60 * 1000);
            if (age < 16 || age > 100) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        if (field.name.includes('membership') && date > today) {
            field.classList.add('is-invalid');
            return false;
        }
        
        field.classList.add('is-valid');
    }
    
    return true;
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function formatPhoneNumber(field) {
    let value = field.value.replace(/[^\d+]/g, '');
    
    if (value.startsWith('0') && value.length === 10) {
        value = '+256' + value.substring(1);
    } else if (value.startsWith('256') && value.length === 12) {
        value = '+' + value;
    } else if (value.startsWith('7') && value.length === 9) {
        value = '+256' + value;
    }
    
    field.value = value;
}

function capitalizeField(field) {
    const words = field.value.split(' ');
    const capitalizedWords = words.map(word => {
        if (word.length > 0) {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }
        return word;
    });
    field.value = capitalizedWords.join(' ');
}

function resetForm() {
    if (confirm('Are you sure you want to reset all changes? This will restore the original values.')) {
        location.reload();
    }
}

console.log('Member Form JavaScript loaded successfully');
</script>

{% endblock %}